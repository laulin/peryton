version: "3.9"
services:
  # https://belginux.com/installer-wireguard-easy-avec-docker/
  vpn:
    image: ghcr.io/wg-easy/wg-easy
    container_name: vpn
    restart: unless-stopped
    sysctls:
        - net.ipv4.ip_forward=1
        - net.ipv4.conf.all.src_valid_mark=1
    cap_add:
        - SYS_MODULE
        - NET_ADMIN
    ports:
        - '51820:51820/udp'
        - '51821:51821/tcp'
    volumes:
        - '/server/wg-easy:/etc/wireguard'
    environment:
        - PASSWORD_HASH=$$2a$$12$$axqdo7sfhujrDpoJwz0yqOYHWdG.vFqm9deRb1F.K5xFu8K0XLqmq
        - WG_HOST={{public_ip}}
        - WG_DEFAULT_DNS=172.19.0.10
        - LANG=fr
    networks:
      - front_net

  # caddy:
  #   image: caddy:2
  #   container_name: caddy
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - /server/caddy/Caddyfile:/etc/caddy/Caddyfile
  #     - /server/caddy/logs:/var/log/caddy
  #     - caddy_data:/data
  #     - caddy_config:/config
  #   networks:
  #     - n8n
  #     - dmz
      # networks:
      #   front_net:
      #     ipv4_address: 172.19.0.20     # stable si tu veux un A record DNS
      #   back_net: {}

  dnsmasq:
    image: dockurr/dnsmasq
    container_name: dnsmasq
    environment:
      DNS1: "94.140.14.14"
      DNS2: "94.140.15.15"
    volumes:
      - /server/dnsmasq/:/etc/dnsmasq.d/
    restart: unless-stopped
    networks:
      front_net:
        ipv4_address: 172.19.0.10

  # homepage:
  #   image: ghcr.io/gethomepage/homepage:latest
  #   container_name: homepage
  #   ports:
  #     - 3000:3000/tcp
  #   volumes:
  #     - /server/homepage/config:/app/config 
  #     - /server/homepage/images:/app/public/images
  #   environment:
  #     PUID: 1000
  #     PGID: 1000
  #   restart: unless-stopped
  #   networks:
  #     - n8n


networks:
  front_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.19.0.0/24
  back_net:
    driver: bridge
    internal: true               
    ipam:
      config:
        - subnet: 172.20.0.0/24

volumes:
  caddy_data:
  caddy_config:
