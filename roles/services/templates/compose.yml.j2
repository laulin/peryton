services:
  # https://belginux.com/installer-wireguard-easy-avec-docker/
  vpn:
    image: ghcr.io/wg-easy/wg-easy:15
    container_name: vpn
    restart: unless-stopped
    sysctls:
        - net.ipv4.ip_forward=1
        - net.ipv4.conf.all.src_valid_mark=1
    cap_add:
        - SYS_MODULE
        - NET_ADMIN
    ports:
        - '51820:51820/udp'
    volumes:
        - '/server/wg-easy:/etc/wireguard'
    environment:
        INIT_ENABLED: "true"
        INIT_USERNAME: "admin"
        INIT_PASSWORD: "{{ vpn_password }}"
        INIT_HOST: "{{ wg_easy_host }}"
        INIT_PORT: "{{ wg_easy_port }}"
        INIT_DNS: "172.19.0.10"
        INIT_IPV4_CIDR: "{{ wg_easy_ipv4_cidr }}"
        INIT_ALLOWED_IPS: "0.0.0.0/0"
        DISABLE_IPV6: "true"
        LANG: fr
        WG_PORT: 51820
    networks:
      front_net:
        ipv4_address: 172.19.0.30

  caddy:
    image: caddy:2
    container_name: caddy
    restart: unless-stopped
    ports:
      - "127.0.0.1:80:80"
      - "127.0.0.1:443:443"
    volumes:
      - /server/caddy/Caddyfile:/etc/caddy/Caddyfile
      - /server/caddy/logs:/var/log/caddy
      - /server/pki/certs:/certs:ro
      - /server/pki/crl:/crl:ro
      - /server/ressources:/ressources:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      front_net:
        ipv4_address: 172.19.0.20
      back_net: 
        ipv4_address: 172.20.0.20

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    volumes:
      - /server/homepage/config:/app/config 
      - /server/homepage/images:/app/public/images
    environment:
      PUID: 1000
      PGID: 1000
      HOMEPAGE_ALLOWED_HOSTS: "*" # unsecured 
    restart: unless-stopped
    networks:
      back_net:
        ipv4_address: 172.20.0.10
    dns:
      - 172.19.0.10

  gogs:
    image: gogs/gogs:latest
    container_name: gogs
    restart: unless-stopped
    networks:
      front_net:
        ipv4_address: 172.19.0.40
      back_net:
        ipv4_address: 172.20.0.40
    volumes:
      - /server/gogs:/data
    environment:
      - TZ=Europe/Paris

  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    environment:
      TZ: 'Europe/Paris'
      FTLCONF_webserver_api_password: {{pihole_admin_password}}
    volumes:
      - '/server/pihole/etc-pihole:/etc/pihole'
    restart: unless-stopped
    networks:
      front_net:
        ipv4_address: 172.19.0.10

  docsify:
    image: ghcr.io/rockbenben/docsify-server:latest
    container_name: docsify
    restart: unless-stopped
    volumes:
      - /server/docsify:/docs
    networks:
      back_net:
        ipv4_address: 172.20.0.50

  qcm:
    build: /server/fqcm
    container_name: qcm
    restart: unless-stopped
    command: "python3 -m fqcm -q /fqcm/survey.json -i 0.0.0.0 -p 8888 -n {{qcm.number_of_questions}} --password {{qcm.password}} -o /output"
    volumes:
       - /server/fqcm/survey.json:/fqcm/survey.json:ro
       - /server/fqcm_output:/output
    networks:
      back_net:
        ipv4_address: 172.20.0.60


networks:
  front_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.19.0.0/24
  back_net:
    driver: bridge
    internal: true               
    ipam:
      config:
        - subnet: 172.20.0.0/24

volumes:
  caddy_data:
  caddy_config:
