---
- name: Check Gogs reachability
  uri:
    url: "{{ gogs_url }}"
    status_code: [200, 302]
    return_content: no
    validate_certs: no
  register: gogs_check
  until: gogs_check.status in [200, 302]
  retries: 10
  delay: 2

- name: Check if Gogs is already installed (check redirect)
  uri:
    url: "{{ gogs_url }}"
    method: GET
    follow_redirects: no
    status_code: [200, 302]
    validate_certs: no
  register: gogs_root

- name: Install Gogs
  when: gogs_root.status == 302 and '/install' in gogs_root.location
  block:
    - name: Fetch install page
      ansible.builtin.uri:
        url: "{{ gogs_url }}/install"
        method: GET
        return_content: yes
        validate_certs: no
        follow_redirects: none
      register: install_page

    - name: Extract CSRF token
      ansible.builtin.set_fact:
        gogs_csrf_token: >-
          {{
            (install_page.content
              | regex_findall('name="_csrf" content="([^"]+)"')
              | first) | default('')
          }}

    - name: Fail if CSRF token not found
      ansible.builtin.fail:
        msg: "Could not extract CSRF token from install page"
      when: gogs_csrf_token | length < 10

    - name: Build Cookie header (force _csrf)
      ansible.builtin.set_fact:
        gogs_cookie_header: >-
          {{
            (
              (install_page.cookies_string | default(''))
              | regex_replace('(^|;\\s*)_csrf=[^;]*', '\\1_csrf=' ~ gogs_csrf_token)
            )
            ~ ( '; _csrf=' ~ gogs_csrf_token if ((install_page.cookies_string | default('')) is not search('_csrf=')) else '' )
          }}

    - name: Submit installation form (minimal)
      ansible.builtin.uri:
        url: "{{ gogs_url }}/install"
        method: POST
        validate_certs: no
        body_format: form-urlencoded
        follow_redirects: none
        status_code: [302, 200]
        return_content: yes
        headers:
          Referer: "{{ gogs_url }}/install"
          Cookie: "{{ gogs_cookie_header }}"
        body:
          _csrf: "{{ gogs_csrf_token }}"

          db_type: "SQLite3"
          db_host: ""
          db_user: ""
          db_passwd: ""
          db_name: ""
          db_schema: ""
          ssl_mode: "disable"
          db_path: "/app/gogs/data/gogs.db"

          app_name: "Gogs"
          repo_root_path: "/data/git/gogs-repositories"
          run_user: "git"
          domain: "gogs.cyber"
          ssh_port: "22"
          http_port: "3000"
          app_url: "https://gogs.cyber/"
          log_root_path: "/app/gogs/log"
          default_branch: "master"

          admin_name: "{{ gogs_admin_user }}"
          admin_passwd: "{{ gogs_admin_pass }}"
          admin_confirm_passwd: "{{ gogs_admin_pass }}"
          admin_email: "{{ gogs_admin_email }}"
      register: install_submit
